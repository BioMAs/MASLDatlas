name: Deploy MASLDatlas to Development Server

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild datasets'
        required: false
        default: false
        type: boolean

env:
  DEV_SERVER_PATH: /home/dev/masldatlas
  CONTAINER_NAME: masldatlas-dev

jobs:
  deploy-dev:
    name: Deploy to Development Server
    runs-on: ubuntu-latest
    environment: "DEV_SCILICIUM"
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Transfer source code to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        source: "."
        target: "${{ env.DEV_SERVER_PATH }}"
        overwrite: true
        tar_tmp_path: "/tmp"
        rm: false

    - name: Setup datasets and deploy application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        script: |
          cd ${{ env.DEV_SERVER_PATH }}
          
          echo "ğŸš€ Starting MASLDatlas deployment..."
          
          # Create backup if directory exists
          if [ -d "${{ env.DEV_SERVER_PATH }}_old" ]; then
            echo "ğŸ“¦ Creating backup..."
            BACKUP_DIR="${{ env.DEV_SERVER_PATH }}_backup_$(date +%Y%m%d_%H%M%S)"
            cp -r "${{ env.DEV_SERVER_PATH }}" "$BACKUP_DIR"
            echo "âœ… Backup created at $BACKUP_DIR"
          fi
          
          # Stop existing containers
          echo "ï¿½ Stopping existing containers..."
          docker-compose down || true
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # Clean up old images if force rebuild
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ğŸ§¹ Force rebuild requested - cleaning Docker images..."
            docker rmi masldatlas-app:latest 2>/dev/null || true
            docker system prune -f
          fi
          
          echo "ğŸ”§ Setting permissions..."
          chmod +x scripts/dataset-management/*.sh 2>/dev/null || true
          chmod +x scripts/deployment/*.sh 2>/dev/null || true
          chmod +x scripts/setup/*.sh 2>/dev/null || true
          
          echo "ï¿½ğŸ“Š Setting up datasets..."
          
          # Create necessary directories
          mkdir -p datasets/{Human,Mouse,Zebrafish,Integrated}
          mkdir -p enrichment_sets
          mkdir -p app_cache
          mkdir -p logs
          
          # Check if datasets need to be downloaded
          DATASET_COUNT=$(find datasets -name "*.h5ad" 2>/dev/null | wc -l)
          
          if [ "$DATASET_COUNT" -lt 4 ] || [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "â¬‡ï¸ Downloading datasets..."
            if [ -f "./scripts/dataset-management/manage_volume.sh" ]; then
              ./scripts/dataset-management/manage_volume.sh download
            else
              echo "âš ï¸ Dataset management script not found, skipping download"
            fi
          else
            echo "âœ… Datasets already present ($DATASET_COUNT files found)"
          fi
          
          echo "ğŸ³ Building and starting Docker containers..."
          docker-compose down || true
          docker-compose up -d --build --force-recreate
          
          echo "â³ Waiting for application startup..."
          sleep 30
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          max_attempts=12
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f http://localhost:3838/ >/dev/null 2>&1; then
              echo "âœ… Application is healthy and accessible!"
              break
            fi
            
            echo "ğŸ”„ Attempt $attempt/$max_attempts - waiting for application..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ Health check failed - checking logs..."
            docker logs ${{ env.CONTAINER_NAME }} --tail 50 || docker-compose logs --tail 50
            exit 1
          fi
          
          echo "ğŸ“Š Deployment Status:"
          docker ps | grep masldatlas || docker-compose ps
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Application accessible at: http://$(hostname -I | awk '{print $1}'):3838"
          
          echo "ğŸ“ Deployment Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ• Deployment Time: $(date)"
          echo "ğŸ“‚ Project Path: ${{ env.DEV_SERVER_PATH }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Job pour nettoyer les anciens dÃ©ploiements
  cleanup-old-deployments:
    name: Cleanup Old Deployments
    runs-on: ubuntu-latest
    environment: "DEV_SCILICIUM"
    needs: deploy-dev
    if: success()
    
    steps:
    - name: Cleanup old backups and Docker resources
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        script: |
          echo "ğŸ§¹ Cleaning up old backups..."
          
          # Keep only the 5 most recent backups
          ls -dt /home/dev/masldatlas_backup_* 2>/dev/null | tail -n +6 | xargs rm -rf || true
          
          echo "ğŸ³ Cleaning up unused Docker resources..."
          docker system prune -f --filter "until=24h"
          
          echo "ğŸ’¾ Current disk usage:"
          du -sh ${{ env.DEV_SERVER_PATH }}
          
          echo "âœ… Cleanup completed"
